# This file is managed by Puppet

# SINGULARITY.CONF
# This is the global configuration file for Singularity. This file controls
# what the container is allowed to do on a particular host, and as a result
# this file must be owned by root.


# ALLOW SETUID: [BOOL]
# DEFAULT: yes
# Should we allow users to utilize the setuid binary for launching singularity?
# The majority of features require this to be set to yes, but newer Fedora and
# Ubuntu kernels can provide limited functionality in unprivileged mode.
<% if scope.lookupvar('::singularity::allow_setuid') -%>
allow setuid = yes
<% else -%>
allow setuid = no
<% end -%>


# ALLOW PID NS: [BOOL]
# DEFAULT: yes
# Should we allow users to request the PID namespace?
<% if scope.lookupvar('::singularity::allow_pid_ns') -%>
allow pid ns = yes
<% else -%>
allow pid ns = no
<% end -%>


# ENABLE OVERLAY: [BOOL]
# DEFAULT: yes
# Enabling this option will make it possible to specify bind paths to locations
# that do not currently exist within the container. Some limitations still exist
# when running in completely non-privileged mode. (note: this option is only
# supported on hosts that support overlay file systems).
# note: currently disabled because RHEL7 kernel crashes with it... :(
<% if scope.lookupvar('::singularity::enable_overlay') -%>
enable overlay = yes
<% else -%>
enable overlay = no
<% end -%>


# CONFIG PASSWD: [BOOL]
# DEFAULT: yes
# If /etc/passwd exists within the container, this will automatically append
# an entry for the calling user.
<% if scope.lookupvar('::singularity::config_passwd') -%>
config passwd = yes
<% else -%>
config passwd = no
<% end -%>


# CONFIG GROUP: [BOOL]
# DEFAULT: yes
# If /etc/group exists within the container, this will automatically append
# an entry for the calling user.
<% if scope.lookupvar('::singularity::config_group') -%>
config group = yes
<% else -%>
config group = no
<% end -%>


# CONFIG RESOLV_CONF: [BOOL]
# DEFAULT: yes
# If there is a bind point within the container, use the host's
# /etc/resolv.conf.
<% if scope.lookupvar('::singularity::config_resolv_conf') -%>
config resolv_conf = yes
<% else -%>
config resolv_conf = no
<% end -%>


# MOUNT PROC: [BOOL]
# DEFAULT: yes
# Should we automatically bind mount /proc within the container?
<% if scope.lookupvar('::singularity::mount_proc') -%>
mount proc = yes
<% else -%>
mount proc = no
<% end -%>


# MOUNT SYS: [BOOL]
# DEFAULT: yes
# Should we automatically bind mount /sys within the container?
<% if scope.lookupvar('::singularity::mount_sys') -%>
mount sys = yes
<% else -%>
mount sys = no
<% end -%>


# MOUNT DEV: [yes/no/minimal]
# DEFAULT: yes
# Shoudl we automatically bind mount /dev within the container? If you select
# minimal, and if overlay is enabled, then Singularity will attempt to create
# the following devices inside the container: null, zero, random, urandom
# note: This requires 'enable overlay = yes'
<% if scope.lookupvar('::singularity::mount_dev') -%>
mount dev = yes
<% else -%>
mount dev = no
<% end -%>


# MOUNT HOME: [BOOL]
# DEFAULT: yes
# Should we automatically determine the calling user's home directory and
# attempt to mount it's base path into the container? If the --contain option
# is used, the home directory will be created within the session directory or
# can be overridden with the SINGULARITY_HOME or SINGULARITY_WORKDIR
# environment variables (or their corresponding command line options).
<% if scope.lookupvar('::singularity::mount_home') -%>
mount home = yes
<% else -%>
mount home = no
<% end -%>


# MOUNT TMP: [BOOL]
# DEFAULT: yes
# Should we automatically bind mount /tmp and /var/tmp into the container? If
# the --contain option is used, both tmp locations will be created in the
# session directory or can be specified via the  SINGULARITY_WORKDIR
# environment variable (or the --workingdir command line option).
<% if scope.lookupvar('::singularity::mount_tmp') -%>
mount tmp = yes
<% else -%>
mount tmp = no
<% end -%>


# MOUNT HOSTFS: [BOOL]
# DEFAULT: no
# Probe for all mounted file systems that are mounted on the host, and bind
# those into the container?
<% if scope.lookupvar('::singularity::mount_hostfs') -%>
mount hostfs = yes
<% else -%>
mount hostfs = no
<% end -%>


# BIND PATH: [STRING]
# DEFAULT: Undefined
# Define a list of files/directories that should be made available from within
# the container. The file or directory must exist within the container on
# which to attach to. you can specify a different source and destination
# path (respectively) with a colon; otherwise source and dest are the same.
#bind path = /etc/singularity/default-nsswitch.conf:/etc/nsswitch.conf
#bind path = /opt
#bind path = /scratch
<% bind_path = scope.lookupvar('::singularity::bind_path') -%>
<% if bind_path.is_a?(Array) -%>
<% bind_path.each do |bp| -%>
<% if bp =~ /^\/([^\/\0]+\/*)+$/ -%>
bind path = <%= bp %>
<% elsif bp.is_a?(Hash) -%>
bind path = <%= bp['source'] %>:<%= bp['destination'] %>
<% end -%>
<% end -%>
<% end -%>


# USER BIND CONTROL: [BOOL]
# DEFAULT: yes
# Allow users to influence and/or define bind points at runtime? This will allow
# users to specify bind points, scratch and tmp locations. (note: User bind
# control is only allowed if the host also supports PR_SET_NO_NEW_PRIVS)
<% if scope.lookupvar('::singularity::user_bind_control') -%>
user bind control = yes
<% else -%>
user bind control = no
<% end -%>


# MOUNT SLAVE: [BOOL]
# DEFAULT: yes
# Should we automatically propagate file-system changes from the host?
# This should be set to 'yes' when autofs mounts in the system should
# show up in the container.
<% if scope.lookupvar('::singularity::mount_slave') -%>
mount slave = yes
<% else -%>
mount slave = no
<% end -%>


# CONTAINER DIR: [STRING]
# DEFAULT: /var/singularity/mnt
# This path specifies the location to use for mounting the container, overlays
# and other necessary file systems for the container. Note, this location
# absolutely must be local on this host.
container dir = <%= scope.lookupvar('::singularity::container_dir') %>


# SESSIONDIR PREFIX: [STRING]
# DEFAULT: /tmp/.singularity-session-
# This specifies the prefix for the session directory. Appended to this string
# is an identification string unique to each user and container. Note, this
# location absolutely must be local on this host. If the default location of
# /tmp/ does not work for your system, /var/singularity/sessions maybe a
# better option.
#sessiondir prefix = /var/singularity/sessions/
sessiondir prefix = <%= scope.lookupvar('::singularity::sessiondir_prefix') %>
